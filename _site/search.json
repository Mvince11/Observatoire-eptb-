[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "",
    "text": "L’inondation est le premier risque naturel en France, il menace des vies, des habitations, des emplois. Bien qu’épargnés ces dernières années, les bassins de la Vienne et du Clain ont connu des inondations par le passé et les évènements récents sur des territoires voisins incitent à une prise de conscience de la population. La gestion du risque inondation dépend de la vulnérabilité du territoire qui se traduit ici comme la propension pour des personnes, des biens et des activités à être affectés par ce phénomène. Appréhender les différentes vulnérabilités est une composante essentielle du défi «Mieux savoir pour mieux agir» identifié au niveau national. Partager cette connaissance avec le plus grand nombre est le principal objectif de cet observatoire."
  },
  {
    "objectID": "index.html#pourquoi-un-observatoire",
    "href": "index.html#pourquoi-un-observatoire",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "",
    "text": "L’inondation est le premier risque naturel en France, il menace des vies, des habitations, des emplois. Bien qu’épargnés ces dernières années, les bassins de la Vienne et du Clain ont connu des inondations par le passé et les évènements récents sur des territoires voisins incitent à une prise de conscience de la population. La gestion du risque inondation dépend de la vulnérabilité du territoire qui se traduit ici comme la propension pour des personnes, des biens et des activités à être affectés par ce phénomène. Appréhender les différentes vulnérabilités est une composante essentielle du défi «Mieux savoir pour mieux agir» identifié au niveau national. Partager cette connaissance avec le plus grand nombre est le principal objectif de cet observatoire."
  },
  {
    "objectID": "index.html#des-indicateurs-pour-connaître-la-vulnérabilité",
    "href": "index.html#des-indicateurs-pour-connaître-la-vulnérabilité",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "Des indicateurs pour connaître la vulnérabilité",
    "text": "Des indicateurs pour connaître la vulnérabilité\n\n\n L’observatoire permet la visualisation de plusieurs indicateurs, calculés à partir d’une méthode nationale. Ils s’appuient tous sur une crue dite centennale c’est-à-dire qui a «une chance» sur 100 de se produire tous les ans. Ces indicateurs permettent de décrire la vulnérabilité mais ils peuvent également être utilisés pour évaluer l'efficacité des actions menées sur le terrain qui visent à réduire le risque. Ils sont répartis selon 3 objectifs :  • Objectif 1 : Augmenter la sécurité des populations exposées,  • Objectif 2 : Stabiliser à court terme et réduire à moyen terme le coût des dommages,  • Objectif 3 : Raccourcir fortement le délai de retour à la normale des territoires sinistrés.  \n\n\n\n  Les indicateurs ont été actuellement calculés sur le territoire de Grand Poitiers et quelques communes qui jalonnent la Vienne dont Châtellerault. Dans le futur, ils ont vocation à être étendus au périmètre de la stratégie locale de gestion du risque inondation Vienne – Clain. Cet observatoire vous permet de consulter pour chaque indicateur de vulnérabilité un onglet dédié comprenant une carte dynamique, des graphiques et des résultats bruts et une fiche téléchargeable et imprimable avec les éléments de construction de l'indicateur et la carte de vulnérabilité."
  },
  {
    "objectID": "index.html#les-auteurs-de-lobservatoire",
    "href": "index.html#les-auteurs-de-lobservatoire",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "Les auteurs de l’observatoire",
    "text": "Les auteurs de l’observatoire\n\n\n L’observatoire est le fruit d’une collaboration entre l’Etablissement Public Territorial du Bassin (EPTB) de la Vienne et le CEREMA. Plusieurs collectivités et services de l’Etat ont contribué également à son élaboration (Grand Poitiers, Grand Châtellerault, CC. Vienne et Gartempe, Département de la Vienne, DDT de la Vienne, DREAL Nouvelle Aquitaine). Le financement de ce projet s’insère dans un Programme d’Action de Prévention des Inondations (PAPI) financé par l’Etat (Fonds Barnier) et l’Europe (Plan Loire). \n\n\n\n \n\n\n  \n  \n  \n    \n       Nous contacter\n    \n    (contact@eptb-vienne.fr)"
  },
  {
    "objectID": "js/readme.html",
    "href": "js/readme.html",
    "title": "Pour mémoire",
    "section": "",
    "text": "version 4.5.1 téléchargée le 8 août 2024 https://unpkg.com/maplibre-gl@4.5.1/dist/maplibre-gl.js https://unpkg.com/maplibre-gl@4.5.1/dist/maplibre-gl.css\n&lt;script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'&gt;&lt;/script&gt;\n&lt;link href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' rel='stylesheet' /&gt;\n\n\n\nversion 3.0.7 téléchargée le 8 août 2024 https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js\n\n\n\nversion 7.0.0 téléchargée le 8 août 2024\nhttps://cdn.jsdelivr.net/npm/@turf/turf@latest/turf.min.js\n\n\n\ninclude-in-header: text: | \n\n&lt;script src=\"https://cdn.jsdelivr.net/npm/maplibre-gl@4.2.0/dist/maplibre-gl.min.js\"&gt;&lt;/script&gt;\n&lt;link href=\"https://cdn.jsdelivr.net/npm/maplibre-gl@4.2.0/dist/maplibre-gl.min.css\" rel=\"stylesheet\"&gt;\n&lt;script src=\"https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js\"&gt;&lt;/script&gt;"
  },
  {
    "objectID": "js/readme.html#maplibre",
    "href": "js/readme.html#maplibre",
    "title": "Pour mémoire",
    "section": "",
    "text": "version 4.5.1 téléchargée le 8 août 2024 https://unpkg.com/maplibre-gl@4.5.1/dist/maplibre-gl.js https://unpkg.com/maplibre-gl@4.5.1/dist/maplibre-gl.css\n&lt;script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'&gt;&lt;/script&gt;\n&lt;link href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' rel='stylesheet' /&gt;"
  },
  {
    "objectID": "js/readme.html#pmtiles",
    "href": "js/readme.html#pmtiles",
    "title": "Pour mémoire",
    "section": "",
    "text": "version 3.0.7 téléchargée le 8 août 2024 https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"
  },
  {
    "objectID": "js/readme.html#turf",
    "href": "js/readme.html#turf",
    "title": "Pour mémoire",
    "section": "",
    "text": "version 7.0.0 téléchargée le 8 août 2024\nhttps://cdn.jsdelivr.net/npm/@turf/turf@latest/turf.min.js"
  },
  {
    "objectID": "js/readme.html#pour-mémoire-les-cdn-qui-fonctionnaient",
    "href": "js/readme.html#pour-mémoire-les-cdn-qui-fonctionnaient",
    "title": "Pour mémoire",
    "section": "",
    "text": "include-in-header: text: | \n\n&lt;script src=\"https://cdn.jsdelivr.net/npm/maplibre-gl@4.2.0/dist/maplibre-gl.min.js\"&gt;&lt;/script&gt;\n&lt;link href=\"https://cdn.jsdelivr.net/npm/maplibre-gl@4.2.0/dist/maplibre-gl.min.css\" rel=\"stylesheet\"&gt;\n&lt;script src=\"https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js\"&gt;&lt;/script&gt;"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "About this site\n\n1 + 1\n\n[1] 2\n\n\n\n\n\n Back to top"
  },
  {
    "objectID": "Images/apropos_mentions_legales.html",
    "href": "Images/apropos_mentions_legales.html",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "",
    "text": "Établissement Public Territorial du Bassin de la Vienne Bâtiment Galiléo 20 rue Atlantis 87068 Limoges Cedex Tel : 05 55 06 39 42 email : contact@eptb-vienne.fr  Directeur de la publication : Stéphane LORIOT, directeur de l’Établissement Public Territorial du Bassin de la Vienne"
  },
  {
    "objectID": "Images/apropos_mentions_legales.html#editeur",
    "href": "Images/apropos_mentions_legales.html#editeur",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "",
    "text": "Établissement Public Territorial du Bassin de la Vienne Bâtiment Galiléo 20 rue Atlantis 87068 Limoges Cedex Tel : 05 55 06 39 42 email : contact@eptb-vienne.fr  Directeur de la publication : Stéphane LORIOT, directeur de l’Établissement Public Territorial du Bassin de la Vienne"
  },
  {
    "objectID": "Images/apropos_mentions_legales.html#crédits",
    "href": "Images/apropos_mentions_legales.html#crédits",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "Crédits",
    "text": "Crédits\n\n Photos Nouvelle République Centre Presse Illustrations Mayane Établissement Public Territorial du Bassin de la Vienne"
  },
  {
    "objectID": "Images/apropos_mentions_legales.html#droits-de-reproduction",
    "href": "Images/apropos_mentions_legales.html#droits-de-reproduction",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "Droits de reproduction",
    "text": "Droits de reproduction\n\n En application de la loi du 11 mars 1957 (art. 41) et du code de la propriété intellectuelle du 1er juillet 1992 : l’ensemble des textes, illustrations, photographies, plans, dessins, animations, vidéos, sons contenus sur ce site ne peuvent être utilisés ou reproduits sans l’autorisation de l’éditeur. Pour toute demande de reproduction ou d’utilisation d’éléments contenus sur ce site, contactez l’Établissement Public Territorial du Bassin de la Vienne à l’adresse ci-dessus."
  },
  {
    "objectID": "Images/apropos_mentions_legales.html#confidentialité",
    "href": "Images/apropos_mentions_legales.html#confidentialité",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "Confidentialité",
    "text": "Confidentialité\n\n Cookies Les cookies envoyés par le serveur ont uniquement pour fonction d’améliorer le confort de navigation sur le site. Leur non acceptation par votre navigateur n’entraîne aucune restriction concernant l’accès au contenu. La durée de vie des cookies envoyés est limitée à la durée de la session en cours.\nConfidentialité des données Nous nous engageons à protéger vos données personnelles et votre vie privée. Nous utilisons les informations que vous nous transmettez pour traiter vos demandes et vous faire part de notre réponse.\nCommunication de vos données personnelles à des tiers Nous ne vendons, ni ne louons ni ne communiquons gratuitement à des tiers les informations vous concernant.\nModification de vos informations En application de l’article 27 de la loi Informatique et Libertés du 6 janvier 1978, vous disposez d’un droit d’accès et de rectification sur les données vous concernant. Pour exercer ces droits, il vous suffit de contacter par mail, courrier ou formulaire de contact l’éditeur de ce site."
  },
  {
    "objectID": "Images/apropos_mentions_legales.html#hébergement",
    "href": "Images/apropos_mentions_legales.html#hébergement",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "Hébergement",
    "text": "Hébergement\n\n Ce site est hébergé via le service shinyapps.io de RStudio."
  },
  {
    "objectID": "Images/apropos_mentions_legales.html#conception",
    "href": "Images/apropos_mentions_legales.html#conception",
    "title": "Observatoire de la vulnérabilité aux inondations Vienne - Clain",
    "section": "Conception",
    "text": "Conception\n\n Ce site a été conçu et développé par le Cerema."
  },
  {
    "objectID": "batiments_plain_pied.html",
    "href": "batiments_plain_pied.html",
    "title": "Carte Intercative",
    "section": "",
    "text": "bbox_sru = FileAttachment(\"layers/bb.json\").json()\n\n\n\n\n\n\n\n Nombre de personnes occupant des bâtiments (logements et activités) de plain-pied fortement inondables (plus de 1,5 m d’eau) \n \n\n Le niveau des eaux peut monter relativement vite pour piéger des personnes dans des locaux ne disposant pas d’un accès vers un étage refuge. Dans les locaux où la hauteur d’eau peut être importante (supérieure à 1,5m), cela représente un danger. \n\n\n Télécharger la fiche indicateur et la carte \n\n\n\nLa zone inondable correspond à l'aléa centennal construit à partir des données disponibles et notamment réglementaires mais en aucun cas ne se substitue aux documents réglementaires en vigueur.\n\nCartographie\n\n\n\nbassin_vienne = FileAttachment(\"layers/bassin_vienne.geojson\").json();\ndepartement = FileAttachment(\"layers/departement.geojson\").json();\nregion = FileAttachment(\"layers/region.geojson\").json();\nepci = FileAttachment(\"layers/epci.geojson\").json();\nperimetre = FileAttachment(\"layers/perimetre.json\").json();\nslgri = FileAttachment(\"layers/slgri.json\").json();\ntri = FileAttachment(\"layers/tri.json\").json();\nzone_inondable = FileAttachment(\"layers/zone_inondable.geojson\").json();\n//indicateurs = FileAttachment(\"layers/indicateurs.json\").json();\ncours_d_eau = FileAttachment(\"layers/cours_d_eau.geojson\").json();\nindicateursGeojson = FileAttachment(\"layers/indicateurs.geojson\").json();\nbatiments = FileAttachment(\"layers/batiments_hauteur.geojson\").json();\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nmap = {\n  const container = html`&lt;div class=\"map-container\" id=\"map\" style=\"height: 665px; width: 100%;\"&gt;&lt;/div&gt;`;\n  yield container;\n\n  &lt;!-- const sourcePlanIGN = { --&gt;\n  &lt;!--   style: 'normal', --&gt;\n  &lt;!--   format: 'image/png', --&gt;\n  &lt;!--   layer: 'GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2' --&gt;\n  &lt;!-- }; --&gt;\n\n  const sourceOrtho = {\n    style: 'normal',\n    format: 'image/jpeg',\n    layer: 'HR.ORTHOIMAGERY.ORTHOPHOTOS'\n  };\n\n  const map = new maplibregl.Map({\n    container: container,\n    style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',\n    &lt;!-- center: [-0.04, 46.3051],  --&gt;\n    zoom: 11\n  });\n\n  map.addControl(new maplibregl.FullscreenControl(), 'top-right');\n  map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-left');\n  map.addControl(new maplibregl.ScaleControl({ maxWidth: 80, unit: 'metric' }));\n  \n\n  const toggleStyle = (useOrtho) =&gt; {\n    if (useOrtho) {\n      map.setLayoutProperty('orthoIGN', 'visibility', 'visible');\n      map.setLayoutProperty('OSM', 'visibility', 'none');\n    } else {\n      map.setLayoutProperty('orthoIGN', 'visibility', 'none');\n      map.setLayoutProperty('OSM', 'visibility', 'visible');\n    }\n  };\n\n  map.on('load', () =&gt; {\n    map.fitBounds(\n    [\n      [-0.04, 46.3051],   // Sud-Ouest\n      [0.7741, 46.8565]   // Nord-Est\n    ],\n    {\n      padding: 20,\n      linear: true,\n      duration: 0\n    }\n  );\n    // Ajout des fonds raster IGN\n    &lt;!-- map.addSource('raster-planign', { --&gt;\n    &lt;!--   type: 'raster', --&gt;\n    &lt;!--   tiles: [ --&gt;\n    &lt;!--     `https://data.geopf.fr/wmts?SERVICE=WMTS&style=${sourcePlanIGN.style}&VERSION=1.0.0&REQUEST=GetTile&format=${sourcePlanIGN.format}&layer=${sourcePlanIGN.layer}&tilematrixset=PM&TileMatrix={z}&TileCol={x}&TileRow={y}` --&gt;\n    &lt;!--   ], --&gt;\n    &lt;!--   tileSize: 256, --&gt;\n    &lt;!--   attribution: '© &lt;a href=\"https://www.ign.fr/\"&gt;IGN&lt;/a&gt;', --&gt;\n    &lt;!--   minzoom: 0, --&gt;\n    &lt;!--   maxzoom: 22 --&gt;\n    &lt;!-- }); --&gt;\n\n    map.addSource('raster-ortho', {\n      type: 'raster',\n      tiles: [\n        `https://data.geopf.fr/wmts?SERVICE=WMTS&style=${sourceOrtho.style}&VERSION=1.0.0&REQUEST=GetTile&format=${sourceOrtho.format}&layer=${sourceOrtho.layer}&tilematrixset=PM&TileMatrix={z}&TileCol={x}&TileRow={y}`\n      ],\n      tileSize: 256,\n      attribution: '© &lt;a href=\"https://www.ign.fr/\"&gt;IGN&lt;/a&gt;',\n      minzoom: 0,\n      maxzoom: 22\n    });\n    \n    map.addSource('raster-osm', {\n  type: 'raster',\n  tiles: [\n    'https://tile.openstreetmap.org/{z}/{x}/{y}.png'\n  ],\n  tileSize: 256,\n  attribution:\n    '© &lt;a href=\"https://www.openstreetmap.org/copyright\"&gt;OpenStreetMap&lt;/a&gt; contributors',\n  minzoom: 0,\n  maxzoom: 19\n    });\n\n    &lt;!-- map.addLayer({ --&gt;\n    &lt;!--   id: 'planIGN', --&gt;\n    &lt;!--   type: 'raster', --&gt;\n    &lt;!--   source: 'raster-planign', --&gt;\n    &lt;!--   layout: { visibility: 'visible' } --&gt;\n    &lt;!-- }); --&gt;\n\n    map.addLayer({\n      id: 'orthoIGN',\n      type: 'raster',\n      source: 'raster-ortho',\n      layout: { visibility: 'none' }\n    });\n    \n     map.addLayer({\n      id: 'OSM',\n      type: 'raster',\n      source: 'raster-osm',\n      layout: { visibility: 'visible' } // tu peux le laisser caché au départ si tu veux le basculer ensuite\n    });\n    \n    //fetch('layers/indicateurs.geojson')\n     //.then(response =&gt; response.json())\n     //.then(indicateursGeojson =&gt; { \n              \n    \n    const layersData = [\n      { data: bassin_vienne, type: 'line', id: 'bassinvienneLayer', color: 'green', layout: {visibility:'none'}},\n      { data: region, type: 'line', id: 'regionLayer', color: 'red', layout: {visibility:'none'} },\n      { data: departement, type: 'line', id: 'departementLayer', color: '#a772b9', width: 2,  layout:{visibility:'none'}},\n      { data: epci, type: 'line', id: 'epciLayer', color: '#567ae3', layout: {visibility:'none'} },\n      { data: indicateursGeojson, // GeoJSON contenant une propriété 's12a' --&gt;\n        type: 'fill',\n        id: 'indicateurs12aLayer',\n        opacity: 0.9,\n        width: 1,\n        dynamicColor: { \n        property: 's12a',\n        mapping: { \n           //'-1': '#f1eeed',\n           //'0': '#ffffff', \n           '10': '#ffffff',\n           '50': '#ffaaaa', \n           '100': '#ff5555'\n          }, \n         default: '#d9d9d9'\n        }\n        , layout: {visibility:'visible'}\n         },\n      { data: zone_inondable, type: 'fill', id: 'zoneinondableLayer', color: '#b4c3ef' , width: 2, opacity: 1, \n      layout: {visibility:'visible'} },\n      { data: cours_d_eau, type: 'line', id: 'coursdeauLayer', color: '#b4c3ef' , width: 2, opacity: 1, \n      layout: {visibility:'visible'} },\n      { data: batiments, type: 'fill-extrusion', id: 'batimentsLayer', width:2, opacity: 1, colorByType: 'ff_dteloctxt', heightProperty: 'hauteur',layout: {visibility:'none'}}\n      \n    ];\n    \n    // Créer le conteneur\n        const legend = document.createElement('div');\n        legend.id = 'legend';\n        legend.style.position = 'absolute';\n        legend.style.top = '82%';\n        legend.style.right = '10px';\n        legend.style.transform = 'translateY(-50%)';\n        legend.style.background = 'white';\n        legend.style.padding = '10px';\n        legend.style.fontSize = '12px';\n        legend.style.borderRadius = '4px';\n        legend.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';\n        legend.style.zIndex = '1'; // pour passer au-dessus de la carte\n        \n        // Contenu de la légende\n        legend.innerHTML = `\n          &lt;strong&gt;Population en zone &lt;br&gt;fortement inondable&lt;/strong&gt;&lt;br&gt;\n          &lt;div&gt;&lt;span style=\"background:#d9d9d9;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; 0&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ffffff;width:12px;height:12px;display:inline-block;margin-right:5px;border:1px solid #ccc;\"&gt;&lt;/span&gt; &lt; 10 &lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ffaaaa;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; 10-50 &lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ff5555;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; 50-100 &lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ff0000;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; &gt; 100 &lt;/div&gt;\n        `;\n        \n        // L’ajouter à la carte (le container MapLibre)\n        map.getContainer().appendChild(legend);\n        \n        //afin de lier la légende à l'indicateur\n        function updateLegendVisibility() {\n        const visibility = map.getLayoutProperty('indicateurs12aLayer', 'visibility');\n        if (visibility === 'none') {\n          legend.style.display = 'none';\n        } else {\n          legend.style.display = 'block';\n        }\n      }\n\n        map.on('idle', updateLegendVisibility);\n        \n        // Créer le conteneur de légende des bâtiments\n        const batimentLegend = document.createElement('div');\n        batimentLegend.id = 'batiment-legend';\n        batimentLegend.style.position = 'absolute';\n        batimentLegend.style.top = '81%';\n        batimentLegend.style.left = '10px';\n        batimentLegend.style.transform = 'translateY(-50%)';\n        batimentLegend.style.background = 'white';\n        batimentLegend.style.padding = '10px';\n        batimentLegend.style.fontSize = '12px';\n        batimentLegend.style.borderRadius = '4px';\n        batimentLegend.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';\n        batimentLegend.style.zIndex = '1';\n        \n        // Contenu de la légende\n        batimentLegend.innerHTML = `\n          &lt;strong&gt;Type de bâtiment&lt;/strong&gt;&lt;br&gt;\n          &lt;div&gt;&lt;span style=\"background:#1f77b4;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Activité&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#2ca02c;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Appartement&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#d9d9d9;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Aucun local&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#9467bd;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Dépendance&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ff7f0e;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Maison&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#e377c2;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Mixte&lt;/div&gt;\n        `;\n        \n        // L’ajouter à la carte\n        map.getContainer().appendChild(batimentLegend);\n        batimentLegend.style.display = 'none'; // Permet de supprimer l'affichage de la légende au chargement de la page\n        \n        // Lier la visibilité à la couche bâtiment\n        function updateBatimentLegendVisibility() {\n          const visibility = map.getLayoutProperty('batimentsLayer', 'visibility');\n          //batimentLegend.style.display = (visibility === 'none') ? 'none' : 'block';\n          if (visibility === 'none') {\n          batimentLegend.style.display = 'none';\n        } else {\n          batimentLegend.style.display = 'block';\n        }\n        }\n        \n        map.on('idle', updateBatimentLegendVisibility);\n     \n    // Ajout des couches vectorielles\n      layersData.forEach(layer =&gt; {\n        map.addSource(layer.id, {\n          type: 'geojson',\n          data: layer.data\n        });\n      \n        const layerConfig = {\n          id: layer.id,\n          type: layer.type,\n          source: layer.id,\n          paint: {},\n          layout: layer.layout\n        };\n      \n        if (layer.type === 'fill') {\n          if (layer.dynamicColor) {\n            const prop = ['get', layer.dynamicColor.property];\n            layerConfig.paint['fill-color'] = [\n              'case',\n              ['!', ['has', layer.dynamicColor.property]], '#d9d9d9',                       // Propriété absente\n              ['any', ['==', ['get', layer.dynamicColor.property], null], ['==', ['get', layer.dynamicColor.property], 0]], '#d9d9d9', // null ou 0\n              ['&lt;', ['get', layer.dynamicColor.property], 10], '#ffffff',\n              ['&lt;', ['get', layer.dynamicColor.property], 50], '#ffaaaa',\n              ['&lt;', ['get', layer.dynamicColor.property], 100], '#ff5555',\n              ['&gt;=', ['get', layer.dynamicColor.property], 100], '#ff0000',\n              '#d9d9d9' // fallback\n            ];\n          } else {\n            layerConfig.paint['fill-color'] = layer.color || '#000000';\n          }\n        \n          layerConfig.paint['fill-opacity'] = layer.opacity || 0.4;\n          layerConfig.paint['fill-outline-color'] = '#000000';\n        \n        } else if (layer.type === 'line') {\n          layerConfig.paint['line-color'] = layer.color || '#000000';\n          layerConfig.paint['line-width'] = layer.width || 1;\n        } else if (layer.type === 'fill-extrusion') {\n          if (layer.colorByType === 'ff_dteloctxt') {\n            layerConfig.paint['fill-extrusion-color'] = [\n              'match',\n              ['get', 'ff_dteloctxt'],\n              'ACTIVITE', '#1f77b4',\n              'APPARTEMENT', '#2ca02c',\n              'AUCUN LOCAL', '#d9d9d9',\n              'DEPENDANCE', '#9467bd',\n              'MAISON', '#ff7f0e',\n              'MIXTE', '#e377c2',\n              '#000000' // fallback\n            ];\n          } else {\n            layerConfig.paint['fill-extrusion-color'] = layer.color || '#000000';\n          }\n        \n          layerConfig.paint['fill-extrusion-height'] = ['get', layer.heightProperty || 'hauteur'];\n          layerConfig.paint['fill-extrusion-base'] = 0;\n          layerConfig.paint['fill-extrusion-opacity'] = layer.opacity || 0.9;\n        }\n      \n        map.addLayer(layerConfig);\n        \n        map.addLayer({\n                  id: 'indicateurs12aLabels',\n                  type: 'symbol',\n                  source: 'indicateurs12aLayer', // le même id que ta source GeoJSON\n                  layout: {\n                    'text-field': ['get', 'nom'],\n                    'text-size': 11,\n                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],\n                    'text-offset': [0, 0.6],\n                    'text-anchor': 'top'\n                  },\n                  paint: {\n                    'text-color': '#000000',\n                    'text-halo-color': '#ffffff',\n                    'text-halo-width': 1\n                  }\n                });\n                \n                map.addLayer({\n                  id: 'indicateurs12aLabels',\n                  type: 'symbol',\n                  source: 'indicateurs12aLayer', // le même id que ta source GeoJSON\n                  layout: {\n                    'text-field': ['get', 'nom'],\n                    'text-size': 11,\n                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],\n                    'text-offset': [0, 0.6],\n                    'text-anchor': 'top'\n                  },\n                  paint: {\n                    'text-color': '#000000',\n                    'text-halo-color': '#ffffff',\n                    'text-halo-width': 1\n                  }\n                });\n                \n        map.addLayer({\n                 id: 'indicateurs12a-hover',\n                 type: 'line',\n                 source: 'indicateurs12aLayer', // même source\n                 paint: {\n                   'line-color': '#000',\n                   'line-width': 2\n                  },\n                 filter: ['==', 'nom', ''] // vide au début\n                  });\n\n      \n      map.on('click', 'indicateurs12aLayer', (e) =&gt; {\n        const feature = e.features[0];\n        const image= feature.properties.image;\n        const nom = feature.properties.nom || 'Non disponible';\n        \n        const population = feature.properties.population\n        ? feature.properties.population.toLocaleString('fr-FR') + ' habitants'\n        : 'Non disponible';\n        \n        const s12aValue = feature.properties.s12a || '0';\n        const dommages = (Number(s12aValue) || 0).toLocaleString('fr-FR');\n        const batimentsValue = feature.properties.nb_batiments;\n        const batiments = !isNaN(parseFloat(batimentsValue))\n          ? parseInt(batimentsValue).toLocaleString('fr-FR')\n          : 'Non disponible';\n        const batindif = feature.properties.nb_bat_indif?.toLocaleString('fr-FR');\n        const batsportifValue = parseFloat(feature.properties.nb_bat_sportif);\n        const batsportif = (!isNaN(batsportifValue) ? batsportifValue : 0).toLocaleString('fr-FR');\n        const batagricolefValue = parseFloat(feature.properties.nb_bat_agricole);\n        const batagricole = (!isNaN(batagricolefValue) ? batagricolefValue : 0).toLocaleString('fr-FR');\n        const batresidentielValue = parseFloat(feature.properties.nb_bat_residentiel);\n        const batresidentiel = (!isNaN(batresidentielValue) ? batresidentielValue : 0).toLocaleString('fr-FR');\n        const batannexeValue = parseFloat(feature.properties.nb_bat_annexe);\n        const batannexe = (!isNaN(batannexeValue) ? batannexeValue : 0).toLocaleString('fr-FR');\n        const batreligieuxValue = parseFloat(feature.properties.nb_bat_religieux);\n        const batreligieux = (!isNaN(batreligieuxValue) ? batreligieuxValue : 0).toLocaleString('fr-FR');\n        const batindustrielValue = parseFloat(feature.properties.nb_bat_industriel);\n        const batindustriel = (!isNaN(batindustrielValue) ? batindustrielValue : 0).toLocaleString('fr-FR');\n        const batcommercialValue = parseFloat(feature.properties.nb_bat_commercial);\n        const batcommercial = (!isNaN(batcommercialValue) ? batcommercialValue : 0).toLocaleString('fr-FR');\n      \n        const popupContent = `\n        &lt;style&gt;\n          .maplibregl-popup-content {\n            padding: 4px !important;\n            border: 1px solid;\n            border-radius: 8px;\n            width: 270px;\n            box-shadow: rgba(101, 147, 220, 0.2) 0px 4px 8px 0px;\n            border-color: rgba(101, 147, 220, 0.5);\n          }\n        &lt;/style&gt;\n           &lt;div style=\"font-family: sans-serif; font-size: 13px; margin:10px;\"&gt;\n          &lt;div style=\"background-color: #d1ee9c; border: 1px solid; border-radius:8px; margin-bottom:16px; padding:10px;\"&gt;&lt;strong&gt;\n          &lt;center&gt;${nom}&lt;/center&gt;\n          &lt;/strong&gt;&lt;/div&gt;\n          &lt;p style=\"text-align:center !important\"&gt;&lt;strong&gt;- Population :&lt;/strong&gt; ${population}&lt;/p&gt;\n          &lt;p style=\"text-align:center !important\"&gt;&lt;strong&gt;- Nombre de personnes en zone fortement inondable :&lt;/strong&gt; ${dommages}&lt;/p&gt;\n        `;\n      \n        new maplibregl.Popup({closeButton: false})\n          .setLngLat(e.lngLat)\n          .setHTML(popupContent)\n          .addTo(map);\n          \n          // Mettre à jour le conteneur HTML avec les informations spécifiques du marqueur \n         document.getElementById('donnees').innerHTML = `\n          &lt;div style=\"text-align:center; font-family:sans-serif; font-size:16px;\"&gt;\n            &lt;img src=\"${image}\" style=\"width:300px; margin-bottom:10px;\"&gt;&lt;br&gt;\n            \n            &lt;strong style=\"font-size:1.1em;\"&gt;&lt;i class=\"bi bi-geo-alt-fill\"&gt;&lt;/i&gt; Commune :&lt;/strong&gt; ${nom}&lt;br&gt;\n            &lt;strong style=\"font-size:1.1em;\"&gt;&lt;i class=\"bi bi-people-fill\"&gt;&lt;/i&gt; Nombre d'habitants :&lt;/strong&gt; ${population}&lt;br&gt;\n            &lt;strong style=\"font-size:1.1em;\"&gt;&lt;i class=\"bi bi-house-fill\"&gt;&lt;/i&gt; Nombre de bâtiments :&lt;/strong&gt; ${batiments}&lt;br&gt;\n            \n            &lt;div style=\"margin-top:10px;\"&gt;&lt;strong&gt;Dont :&lt;/strong&gt;&lt;/div&gt;\n            &lt;ul style=\"list-style:none; padding:0;\"&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batindif} &lt;strong&gt;bâtiments indifférenciés&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batsportif} &lt;strong&gt;bâtiments sportifs&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batagricole} &lt;strong&gt;bâtiments agricoles&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batresidentiel} &lt;strong&gt;bâtiments résidentiels&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batannexe} &lt;strong&gt;bâtiments annexes&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batreligieux} &lt;strong&gt;bâtiments religieux&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batindustriel} &lt;strong&gt;bâtiments industriels&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batcommercial} &lt;strong&gt;bâtiments commerciaux&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n            &lt;/ul&gt;\n        \n            &lt;div style=\"margin-top:10px;\"&gt;\n              &lt;strong style=\"font-size:1.1em;\"&gt;&lt;i class=\"bi bi-droplet-half\"&gt;&lt;/i&gt; Nombre de personnes en zone fortement inondable :&lt;/strong&gt; ${dommages}\n            &lt;/div&gt;\n          &lt;/div&gt;\n         `;\n      });\n\n      map.on('mousemove', 'indicateurs12aLayer', (e) =&gt; {\n        if (e.features.length &gt; 0) {\n          const nomCommune = e.features[0].properties.nom;\n      \n          map.setFilter('indicateurs12a-hover', ['==', 'nom', nomCommune]);\n      \n          map.getCanvas().style.cursor = 'pointer';\n        }\n      });\n\n        map.on('mouseleave', 'indicateurs12aLayer', () =&gt; {\n          map.setFilter('indicateurs12a-hover', ['==', 'nom', '']);\n          map.getCanvas().style.cursor = '';\n        });\n      });\n    \n\n    // Interface de contrôle des couches\n    const mapLayersDiv = document.createElement('div');\n    mapLayersDiv.classList.add('mapLayers');\n    mapLayersDiv.style.position = 'absolute';\n    mapLayersDiv.style.zIndex = '1000';\n    mapLayersDiv.innerHTML = `\n      &lt;button id=\"toggleMapMenuButton\" class=\"btn btn-light aria-label=\"Afficher les couches\" title=\"Afficher les couches\"&gt;\n        &lt;img src=\"Images/icons/layers-half.svg\" alt=\"Icône SVG\" width=\"25\" height=\"25\"&gt;\n      &lt;/button&gt;\n      &lt;div id=\"layersList\" style=\"display: none; background: white; padding: 10px; border: 1px solid #ccc;\"&gt;&lt;/div&gt;\n    `;\n    map.getContainer().appendChild(mapLayersDiv);\n\n    const toggleableLayerIds = layersData.map(layer =&gt; layer.id);\n    const aliasLayerIds = {\n      bassinvienneLayer: 'Bassin de la Vienne',\n      regionLayer: 'Région',\n      departementLayer: 'Département',\n      epciLayer: 'EPCI',\n      zoneinondableLayer: 'Zonage Inondable',\n      coursdeauLayer: \"Cours d'eau\",\n      indicateurs12aLayer: 'Bâtiments de plain-pied',\n      batimentsLayer: \"Bâtiments\"\n    };\n\n    function toggleLayerVisibility(id, visible) {\n      const visibility = visible ? 'visible' : 'none';\n      if (map.getLayer(id)) {\n        map.setLayoutProperty(id, 'visibility', visibility);\n      }\n    }\n\n    const layersListDiv = mapLayersDiv.querySelector('#layersList');\n    \n    toggleableLayerIds.forEach(id =&gt; {\n      const name = aliasLayerIds[id] || id;\n\n      const checkbox = document.createElement('input');\n      checkbox.type = 'checkbox';\n      checkbox.id = id;\n      checkbox.className = 'form-check-input';\n      \n      // ✅ Lire la visibilité actuelle directement dans la carte\n      map.once('idle', () =&gt; {\n        const visibility = map.getLayoutProperty(id, 'visibility');\n        checkbox.checked = visibility === 'visible';\n      });\n  \n      checkbox.addEventListener('change', () =&gt; toggleLayerVisibility(id, checkbox.checked));\n\n      const label = document.createElement('label');\n      label.htmlFor = id;\n      label.className = 'form-check-label';\n      label.innerText = name;\n\n      const wrapper = document.createElement('div');\n      wrapper.className = 'form-check';\n      wrapper.appendChild(checkbox);\n      wrapper.appendChild(label);\n\n      layersListDiv.appendChild(wrapper);\n    });\n\n    document.getElementById('toggleMapMenuButton').addEventListener('click', () =&gt; {\n      layersListDiv.style.display = layersListDiv.style.display === 'none' ? 'block' : 'none';\n    });\n     \n\n    // Menu bascule fond de plan\n    const mapMenuDiv = document.createElement('div');\n    mapMenuDiv.classList.add('mapFondDePlan');\n    mapMenuDiv.style.position = 'absolute';\n    mapMenuDiv.style.zIndex = '1000';\n    mapMenuDiv.innerHTML = `\n      &lt;strong&gt;Fond de plan :&lt;/strong&gt;\n      &lt;div class=\"form-check form-switch\"&gt;\n        &lt;input class=\"form-check-input\" type=\"checkbox\" role=\"switch\" id=\"orthoCheckbox\"&gt;\n        &lt;label class=\"form-check-label\" for=\"orthoCheckbox\"&gt;Photos aériennes&lt;/label&gt;\n      &lt;/div&gt;\n    `;\n    map.getContainer().appendChild(mapMenuDiv);\n\n    document.getElementById('orthoCheckbox').addEventListener('change', function (e) {\n      e.preventDefault();\n      e.stopPropagation();\n      toggleStyle(this.checked);\n    });\n  });\n};\n\n\n\n\n\n\n\nDonnées de la commune {.tabset}\n\nmd`\n&lt;div id=\"donnees\" style=\"font-family: Arial, sans-serif; font-size: 16px; line-height: 1.5; margin-top:1%;\"&gt;\n    Cliquez sur une commune pour voir les informations ici.&lt;br&gt;\n&lt;/div&gt;\n\n`\n\n\n\n\n\n\nTableau de données\n\n\n\n\n\n\nGraphiques\n\nimport { Plot } from \"@observablehq/plot\";\nimport { Inputs } from \"@observablehq/inputs\";\n\n// Charger les données depuis le fichier généré par R\ndata = FileAttachment(\"layers/data_s12a.json\").json()\n\nhtml`&lt;label for=\"slider-s12a\" style=\"display: block;\n  margin-top: 1em;\n  font-weight: bold;\n  margin-bottom: 1em;\n  border: 1px solid rgba(0, 0, 0, 0.6);\n  box-shadow: 0px 0px 8px 0px rgba(0, 0, 0, 0.8);\n  border-radius: 8px;\n  padding: 5px;\n  text-align: center;\n  margin-right: 20%;\n  margin-left: 20%;\"&gt;\n  Population en zone inondable\n&lt;/label&gt;`\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nviewof slider = Inputs.range(\n  [0, 230], \n  { value: 230, step: 10, \n  id: \"slider-s12a\"\n  }\n)\n\nhtml`&lt;div style=\"margin-top: 30px;\"&gt;&lt;/div&gt;`\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nsorted = data\n  .filter(d =&gt; d.s12a &lt;= slider)\n  .sort((a, b) =&gt; a.s12a - b.s12a);\n  \n\nPlot.plot({\n  marks: [\n    Plot.barY(sorted, { x: \"nom\", y: \"s12a\", \n    fill: d =&gt; {\n        const val = d.s12a;\n        if (val === 0) return \"#d9d9d9\";        // null ou 0\n        if (val &lt; 10) return \"#f9e9e9\";\n        if (val &lt; 50) return \"#ffaaaa\";\n        if (val &lt; 100) return \"#ff5555\";\n        if (val &gt;= 100) return \"#ff0000\";\n        return \"#b30000\";\n      }\n      }),\n    Plot.text(sorted, { x: \"nom\", y: \"s12a\", text: d =&gt; `${d.s12a}`, dy: -10 })\n  ],\n  y: { grid: true, label: \"Population en zone fortement inondable\" },\n  x: { label: \"Commune\",\n        tickRotate: -45,\n        labelAnchor: \"right\",\n        labelOffset: 30},\n  width: window.innerWidth * 0.95,\n   height: window.innerHeight * 0.85,\n  height: 600,\n  style: {\n    fontSize: \"10px\",\n    fill: \"black\",\n    fontWeight: \"bold\"\n  },\n  marginBottom: 130\n})\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nInformations relatives à l’indicateur\n\nmd`\n\n&lt;table style=\"width:90%; border-collapse: collapse; border:1px solid; text-align:center; margin:auto;\"&gt;\n  &lt;colgroup&gt;\n    &lt;col style=\"width:20%;\"&gt;\n    &lt;col style=\"width:20%;\"&gt;\n    &lt;col style=\"width:20%;\"&gt;\n    &lt;col style=\"width:20%;\"&gt;\n    &lt;col style=\"width:20%;\"&gt;\n  &lt;/colgroup&gt;\n  &lt;tr&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\" colspan=\"2\"&gt;Numéro d'indicateur&lt;/th&gt;\n    &lt;th style=\"border:1px solid;\"&gt;Ind1/2a&lt;/th&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\"&gt;Date de mise à jour&lt;/th&gt;\n    &lt;th style=\"border:1px solid;\"&gt;31/05/2025&lt;/th&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Intitulé&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;Nombre de personnes occupant des bâtiments (logements et activités) de plain-pied\n        fortement inondables (plus de 1,5 m d’eau)&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Objectif de la SNGRI&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;Objectif n°1 : Augmenter la sécurité des populations exposées&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Axe de vulnérabilité&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;Axe 1/1 La mise en danger des personnes au sein des bâtiments&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Source de vulnérabilité&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;S1/2 Inondation de bâtiments et risque de rupture des ouvrants dans les zones pouvant\n        comporter une hauteur d’eau importante&lt;/td&gt;\n  &lt;/tr&gt;\n&lt;/table&gt;\n\n&lt;br&gt;\n\n&lt;table style=\"width:90%; border-collapse: collapse; border:1px solid; text-align:center; margin:auto;\"&gt;\n  &lt;colgroup&gt;\n    &lt;col style=\"width:20%;\"&gt;\n    &lt;col style=\"width:20%;\"&gt;\n    &lt;col style=\"width:20%;\"&gt;\n    &lt;col style=\"width:20%;\"&gt;\n    &lt;col style=\"width:20%;\"&gt;\n  &lt;/colgroup&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Modalités du calcul&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;On sélectionne les bâtiments (habitation ou activité) de plain-pied qui intersectent la \n        zone d’aléa supérieure à 1,5 m et on comptabilise le nombre de personnes (habitants ou employés). Le résultat est ensuite \n        agrégé à la commune.&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Échelle de représentation&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;Communale&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Points de vigilance&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;Pour les effectifs des employés, les valeurs renseignées dans SIREN sont des fourchettes         de valeurs hautes et basses. Ici, le choix de prendre la valeur haute a été retenu pour éviter de minimiser le total.\n        Lors de l’affectation des personnes au bâtiment, pour des carreaux à faible densité de personnes, des valeurs décimales ont pu         être attribuées aux bâtiments.&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Table cible&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;p_obj1_securite_personnes. s12a_pop_plainpied_zi_fort&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Variables mobilisées&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;Zd : hauteur d’eau &gt; 1.5m,\n        Pop1 : habitants,\n        Pop2 : employés&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Indicateur commun SLGRI Vienne/Clain&lt;/td&gt;\n    &lt;td colspan=\"3\" style=\"border:1px solid;\"&gt;non&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n&lt;/table&gt;\n\n&lt;br&gt;\n\n&lt;table style=\"width:90%; border-collapse: collapse; border:1px solid; text-align:center; margin:auto;\"&gt;\n  &lt;colgroup&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n    &lt;col style=\"width:10%;\"&gt;\n  &lt;/colgroup&gt;\n\n  &lt;tr&gt;\n    &lt;td colspan=\"10\" style=\"background-color:bisque; border:1px solid; font-weight: bold;\"&gt;Données sources&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\" colspan=\"2\"&gt;Désignation&lt;/th&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\"&gt;Millésime&lt;/th&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\"&gt;Nationale/locale&lt;/th&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\"&gt;Format&lt;/th&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\"&gt;Type&lt;/th&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\" colspan=\"2\"&gt;Producteur&lt;/th&gt;\n    &lt;th style=\"background-color:bisque; border:1px solid;\" colspan=\"2\"&gt;Nom fichier&lt;/th&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Hauteur d’eau &gt;1.5m&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;2019&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Locale&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Shape&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Polygone&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Cerema&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;zd_sup_1m50.shp&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Bâtiment BDTOPO&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;2020&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Nationale&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Shape&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Polygone&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;IGN&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Batiment.shp&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Population carreau 200m INSEE&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;2015&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Nationale&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Shape&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Polygone&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;INSEE&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;filosofi2015_carreaux_200m.shp&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Effectif des entreprises&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;2021&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Nationale&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Shape&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Point&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;INSEE&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;geo_siret.shp&lt;/td&gt;\n  &lt;/tr&gt;\n  &lt;tr&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Communes&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;2020&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Nationale&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Shape&lt;/td&gt;\n    &lt;td style=\"border:1px solid;\"&gt;Polygone&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Cerema&lt;/td&gt;\n    &lt;td colspan=\"2\" style=\"border:1px solid;\"&gt;Commune.shp&lt;/td&gt;\n  &lt;/tr&gt;\n&lt;/table&gt;\n\n\n`\n\n\n\n\n\n\nBâtiments en 3D : Mode d’emploi\n Incliner et faire tourner la carte\nMaintenez enfoncé le bouton droit de la souris sur ce symbole  et déplacez le pour incliner le point de vue ou faire tourner la carte.\n Zoomer sur la carte\nZoomer sur la carte (molette de la souris) pour visualiser les bâtiments.\n Une illustration pour bien comprendre la carte interactive\n\n\n\nBâtiments 3D"
  },
  {
    "objectID": "batiments_plain_pied.html#section",
    "href": "batiments_plain_pied.html#section",
    "title": "Carte Intercative",
    "section": "",
    "text": "bassin_vienne = FileAttachment(\"layers/bassin_vienne.geojson\").json();\ndepartement = FileAttachment(\"layers/departement.geojson\").json();\nregion = FileAttachment(\"layers/region.geojson\").json();\nepci = FileAttachment(\"layers/epci.geojson\").json();\nperimetre = FileAttachment(\"layers/perimetre.json\").json();\nslgri = FileAttachment(\"layers/slgri.json\").json();\ntri = FileAttachment(\"layers/tri.json\").json();\nzone_inondable = FileAttachment(\"layers/zone_inondable.geojson\").json();\n//indicateurs = FileAttachment(\"layers/indicateurs.json\").json();\ncours_d_eau = FileAttachment(\"layers/cours_d_eau.geojson\").json();\nindicateursGeojson = FileAttachment(\"layers/indicateurs.geojson\").json();\nbatiments = FileAttachment(\"layers/batiments_hauteur.geojson\").json();\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nmap = {\n  const container = html`&lt;div class=\"map-container\" id=\"map\" style=\"height: 665px; width: 100%;\"&gt;&lt;/div&gt;`;\n  yield container;\n\n  &lt;!-- const sourcePlanIGN = { --&gt;\n  &lt;!--   style: 'normal', --&gt;\n  &lt;!--   format: 'image/png', --&gt;\n  &lt;!--   layer: 'GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2' --&gt;\n  &lt;!-- }; --&gt;\n\n  const sourceOrtho = {\n    style: 'normal',\n    format: 'image/jpeg',\n    layer: 'HR.ORTHOIMAGERY.ORTHOPHOTOS'\n  };\n\n  const map = new maplibregl.Map({\n    container: container,\n    style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',\n    &lt;!-- center: [-0.04, 46.3051],  --&gt;\n    zoom: 11\n  });\n\n  map.addControl(new maplibregl.FullscreenControl(), 'top-right');\n  map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-left');\n  map.addControl(new maplibregl.ScaleControl({ maxWidth: 80, unit: 'metric' }));\n  \n\n  const toggleStyle = (useOrtho) =&gt; {\n    if (useOrtho) {\n      map.setLayoutProperty('orthoIGN', 'visibility', 'visible');\n      map.setLayoutProperty('OSM', 'visibility', 'none');\n    } else {\n      map.setLayoutProperty('orthoIGN', 'visibility', 'none');\n      map.setLayoutProperty('OSM', 'visibility', 'visible');\n    }\n  };\n\n  map.on('load', () =&gt; {\n    map.fitBounds(\n    [\n      [-0.04, 46.3051],   // Sud-Ouest\n      [0.7741, 46.8565]   // Nord-Est\n    ],\n    {\n      padding: 20,\n      linear: true,\n      duration: 0\n    }\n  );\n    // Ajout des fonds raster IGN\n    &lt;!-- map.addSource('raster-planign', { --&gt;\n    &lt;!--   type: 'raster', --&gt;\n    &lt;!--   tiles: [ --&gt;\n    &lt;!--     `https://data.geopf.fr/wmts?SERVICE=WMTS&style=${sourcePlanIGN.style}&VERSION=1.0.0&REQUEST=GetTile&format=${sourcePlanIGN.format}&layer=${sourcePlanIGN.layer}&tilematrixset=PM&TileMatrix={z}&TileCol={x}&TileRow={y}` --&gt;\n    &lt;!--   ], --&gt;\n    &lt;!--   tileSize: 256, --&gt;\n    &lt;!--   attribution: '© &lt;a href=\"https://www.ign.fr/\"&gt;IGN&lt;/a&gt;', --&gt;\n    &lt;!--   minzoom: 0, --&gt;\n    &lt;!--   maxzoom: 22 --&gt;\n    &lt;!-- }); --&gt;\n\n    map.addSource('raster-ortho', {\n      type: 'raster',\n      tiles: [\n        `https://data.geopf.fr/wmts?SERVICE=WMTS&style=${sourceOrtho.style}&VERSION=1.0.0&REQUEST=GetTile&format=${sourceOrtho.format}&layer=${sourceOrtho.layer}&tilematrixset=PM&TileMatrix={z}&TileCol={x}&TileRow={y}`\n      ],\n      tileSize: 256,\n      attribution: '© &lt;a href=\"https://www.ign.fr/\"&gt;IGN&lt;/a&gt;',\n      minzoom: 0,\n      maxzoom: 22\n    });\n    \n    map.addSource('raster-osm', {\n  type: 'raster',\n  tiles: [\n    'https://tile.openstreetmap.org/{z}/{x}/{y}.png'\n  ],\n  tileSize: 256,\n  attribution:\n    '© &lt;a href=\"https://www.openstreetmap.org/copyright\"&gt;OpenStreetMap&lt;/a&gt; contributors',\n  minzoom: 0,\n  maxzoom: 19\n    });\n\n    &lt;!-- map.addLayer({ --&gt;\n    &lt;!--   id: 'planIGN', --&gt;\n    &lt;!--   type: 'raster', --&gt;\n    &lt;!--   source: 'raster-planign', --&gt;\n    &lt;!--   layout: { visibility: 'visible' } --&gt;\n    &lt;!-- }); --&gt;\n\n    map.addLayer({\n      id: 'orthoIGN',\n      type: 'raster',\n      source: 'raster-ortho',\n      layout: { visibility: 'none' }\n    });\n    \n     map.addLayer({\n      id: 'OSM',\n      type: 'raster',\n      source: 'raster-osm',\n      layout: { visibility: 'visible' } // tu peux le laisser caché au départ si tu veux le basculer ensuite\n    });\n    \n    //fetch('layers/indicateurs.geojson')\n     //.then(response =&gt; response.json())\n     //.then(indicateursGeojson =&gt; { \n              \n    \n    const layersData = [\n      { data: bassin_vienne, type: 'line', id: 'bassinvienneLayer', color: 'green', layout: {visibility:'none'}},\n      { data: region, type: 'line', id: 'regionLayer', color: 'red', layout: {visibility:'none'} },\n      { data: departement, type: 'line', id: 'departementLayer', color: '#a772b9', width: 2,  layout:{visibility:'none'}},\n      { data: epci, type: 'line', id: 'epciLayer', color: '#567ae3', layout: {visibility:'none'} },\n      { data: indicateursGeojson, // GeoJSON contenant une propriété 's12a' --&gt;\n        type: 'fill',\n        id: 'indicateurs12aLayer',\n        opacity: 0.9,\n        width: 1,\n        dynamicColor: { \n        property: 's12a',\n        mapping: { \n           //'-1': '#f1eeed',\n           //'0': '#ffffff', \n           '10': '#ffffff',\n           '50': '#ffaaaa', \n           '100': '#ff5555'\n          }, \n         default: '#d9d9d9'\n        }\n        , layout: {visibility:'visible'}\n         },\n      { data: zone_inondable, type: 'fill', id: 'zoneinondableLayer', color: '#b4c3ef' , width: 2, opacity: 1, \n      layout: {visibility:'visible'} },\n      { data: cours_d_eau, type: 'line', id: 'coursdeauLayer', color: '#b4c3ef' , width: 2, opacity: 1, \n      layout: {visibility:'visible'} },\n      { data: batiments, type: 'fill-extrusion', id: 'batimentsLayer', width:2, opacity: 1, colorByType: 'ff_dteloctxt', heightProperty: 'hauteur',layout: {visibility:'none'}}\n      \n    ];\n    \n    // Créer le conteneur\n        const legend = document.createElement('div');\n        legend.id = 'legend';\n        legend.style.position = 'absolute';\n        legend.style.top = '82%';\n        legend.style.right = '10px';\n        legend.style.transform = 'translateY(-50%)';\n        legend.style.background = 'white';\n        legend.style.padding = '10px';\n        legend.style.fontSize = '12px';\n        legend.style.borderRadius = '4px';\n        legend.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';\n        legend.style.zIndex = '1'; // pour passer au-dessus de la carte\n        \n        // Contenu de la légende\n        legend.innerHTML = `\n          &lt;strong&gt;Population en zone &lt;br&gt;fortement inondable&lt;/strong&gt;&lt;br&gt;\n          &lt;div&gt;&lt;span style=\"background:#d9d9d9;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; 0&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ffffff;width:12px;height:12px;display:inline-block;margin-right:5px;border:1px solid #ccc;\"&gt;&lt;/span&gt; &lt; 10 &lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ffaaaa;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; 10-50 &lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ff5555;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; 50-100 &lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ff0000;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; &gt; 100 &lt;/div&gt;\n        `;\n        \n        // L’ajouter à la carte (le container MapLibre)\n        map.getContainer().appendChild(legend);\n        \n        //afin de lier la légende à l'indicateur\n        function updateLegendVisibility() {\n        const visibility = map.getLayoutProperty('indicateurs12aLayer', 'visibility');\n        if (visibility === 'none') {\n          legend.style.display = 'none';\n        } else {\n          legend.style.display = 'block';\n        }\n      }\n\n        map.on('idle', updateLegendVisibility);\n        \n        // Créer le conteneur de légende des bâtiments\n        const batimentLegend = document.createElement('div');\n        batimentLegend.id = 'batiment-legend';\n        batimentLegend.style.position = 'absolute';\n        batimentLegend.style.top = '81%';\n        batimentLegend.style.left = '10px';\n        batimentLegend.style.transform = 'translateY(-50%)';\n        batimentLegend.style.background = 'white';\n        batimentLegend.style.padding = '10px';\n        batimentLegend.style.fontSize = '12px';\n        batimentLegend.style.borderRadius = '4px';\n        batimentLegend.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';\n        batimentLegend.style.zIndex = '1';\n        \n        // Contenu de la légende\n        batimentLegend.innerHTML = `\n          &lt;strong&gt;Type de bâtiment&lt;/strong&gt;&lt;br&gt;\n          &lt;div&gt;&lt;span style=\"background:#1f77b4;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Activité&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#2ca02c;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Appartement&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#d9d9d9;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Aucun local&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#9467bd;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Dépendance&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#ff7f0e;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Maison&lt;/div&gt;\n          &lt;div&gt;&lt;span style=\"background:#e377c2;width:12px;height:12px;display:inline-block;margin-right:5px;\"&gt;&lt;/span&gt; Mixte&lt;/div&gt;\n        `;\n        \n        // L’ajouter à la carte\n        map.getContainer().appendChild(batimentLegend);\n        batimentLegend.style.display = 'none'; // Permet de supprimer l'affichage de la légende au chargement de la page\n        \n        // Lier la visibilité à la couche bâtiment\n        function updateBatimentLegendVisibility() {\n          const visibility = map.getLayoutProperty('batimentsLayer', 'visibility');\n          //batimentLegend.style.display = (visibility === 'none') ? 'none' : 'block';\n          if (visibility === 'none') {\n          batimentLegend.style.display = 'none';\n        } else {\n          batimentLegend.style.display = 'block';\n        }\n        }\n        \n        map.on('idle', updateBatimentLegendVisibility);\n     \n    // Ajout des couches vectorielles\n      layersData.forEach(layer =&gt; {\n        map.addSource(layer.id, {\n          type: 'geojson',\n          data: layer.data\n        });\n      \n        const layerConfig = {\n          id: layer.id,\n          type: layer.type,\n          source: layer.id,\n          paint: {},\n          layout: layer.layout\n        };\n      \n        if (layer.type === 'fill') {\n          if (layer.dynamicColor) {\n            const prop = ['get', layer.dynamicColor.property];\n            layerConfig.paint['fill-color'] = [\n              'case',\n              ['!', ['has', layer.dynamicColor.property]], '#d9d9d9',                       // Propriété absente\n              ['any', ['==', ['get', layer.dynamicColor.property], null], ['==', ['get', layer.dynamicColor.property], 0]], '#d9d9d9', // null ou 0\n              ['&lt;', ['get', layer.dynamicColor.property], 10], '#ffffff',\n              ['&lt;', ['get', layer.dynamicColor.property], 50], '#ffaaaa',\n              ['&lt;', ['get', layer.dynamicColor.property], 100], '#ff5555',\n              ['&gt;=', ['get', layer.dynamicColor.property], 100], '#ff0000',\n              '#d9d9d9' // fallback\n            ];\n          } else {\n            layerConfig.paint['fill-color'] = layer.color || '#000000';\n          }\n        \n          layerConfig.paint['fill-opacity'] = layer.opacity || 0.4;\n          layerConfig.paint['fill-outline-color'] = '#000000';\n        \n        } else if (layer.type === 'line') {\n          layerConfig.paint['line-color'] = layer.color || '#000000';\n          layerConfig.paint['line-width'] = layer.width || 1;\n        } else if (layer.type === 'fill-extrusion') {\n          if (layer.colorByType === 'ff_dteloctxt') {\n            layerConfig.paint['fill-extrusion-color'] = [\n              'match',\n              ['get', 'ff_dteloctxt'],\n              'ACTIVITE', '#1f77b4',\n              'APPARTEMENT', '#2ca02c',\n              'AUCUN LOCAL', '#d9d9d9',\n              'DEPENDANCE', '#9467bd',\n              'MAISON', '#ff7f0e',\n              'MIXTE', '#e377c2',\n              '#000000' // fallback\n            ];\n          } else {\n            layerConfig.paint['fill-extrusion-color'] = layer.color || '#000000';\n          }\n        \n          layerConfig.paint['fill-extrusion-height'] = ['get', layer.heightProperty || 'hauteur'];\n          layerConfig.paint['fill-extrusion-base'] = 0;\n          layerConfig.paint['fill-extrusion-opacity'] = layer.opacity || 0.9;\n        }\n      \n        map.addLayer(layerConfig);\n        \n        map.addLayer({\n                  id: 'indicateurs12aLabels',\n                  type: 'symbol',\n                  source: 'indicateurs12aLayer', // le même id que ta source GeoJSON\n                  layout: {\n                    'text-field': ['get', 'nom'],\n                    'text-size': 11,\n                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],\n                    'text-offset': [0, 0.6],\n                    'text-anchor': 'top'\n                  },\n                  paint: {\n                    'text-color': '#000000',\n                    'text-halo-color': '#ffffff',\n                    'text-halo-width': 1\n                  }\n                });\n                \n                map.addLayer({\n                  id: 'indicateurs12aLabels',\n                  type: 'symbol',\n                  source: 'indicateurs12aLayer', // le même id que ta source GeoJSON\n                  layout: {\n                    'text-field': ['get', 'nom'],\n                    'text-size': 11,\n                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],\n                    'text-offset': [0, 0.6],\n                    'text-anchor': 'top'\n                  },\n                  paint: {\n                    'text-color': '#000000',\n                    'text-halo-color': '#ffffff',\n                    'text-halo-width': 1\n                  }\n                });\n                \n        map.addLayer({\n                 id: 'indicateurs12a-hover',\n                 type: 'line',\n                 source: 'indicateurs12aLayer', // même source\n                 paint: {\n                   'line-color': '#000',\n                   'line-width': 2\n                  },\n                 filter: ['==', 'nom', ''] // vide au début\n                  });\n\n      \n      map.on('click', 'indicateurs12aLayer', (e) =&gt; {\n        const feature = e.features[0];\n        const image= feature.properties.image;\n        const nom = feature.properties.nom || 'Non disponible';\n        \n        const population = feature.properties.population\n        ? feature.properties.population.toLocaleString('fr-FR') + ' habitants'\n        : 'Non disponible';\n        \n        const s12aValue = feature.properties.s12a || '0';\n        const dommages = (Number(s12aValue) || 0).toLocaleString('fr-FR');\n        const batimentsValue = feature.properties.nb_batiments;\n        const batiments = !isNaN(parseFloat(batimentsValue))\n          ? parseInt(batimentsValue).toLocaleString('fr-FR')\n          : 'Non disponible';\n        const batindif = feature.properties.nb_bat_indif?.toLocaleString('fr-FR');\n        const batsportifValue = parseFloat(feature.properties.nb_bat_sportif);\n        const batsportif = (!isNaN(batsportifValue) ? batsportifValue : 0).toLocaleString('fr-FR');\n        const batagricolefValue = parseFloat(feature.properties.nb_bat_agricole);\n        const batagricole = (!isNaN(batagricolefValue) ? batagricolefValue : 0).toLocaleString('fr-FR');\n        const batresidentielValue = parseFloat(feature.properties.nb_bat_residentiel);\n        const batresidentiel = (!isNaN(batresidentielValue) ? batresidentielValue : 0).toLocaleString('fr-FR');\n        const batannexeValue = parseFloat(feature.properties.nb_bat_annexe);\n        const batannexe = (!isNaN(batannexeValue) ? batannexeValue : 0).toLocaleString('fr-FR');\n        const batreligieuxValue = parseFloat(feature.properties.nb_bat_religieux);\n        const batreligieux = (!isNaN(batreligieuxValue) ? batreligieuxValue : 0).toLocaleString('fr-FR');\n        const batindustrielValue = parseFloat(feature.properties.nb_bat_industriel);\n        const batindustriel = (!isNaN(batindustrielValue) ? batindustrielValue : 0).toLocaleString('fr-FR');\n        const batcommercialValue = parseFloat(feature.properties.nb_bat_commercial);\n        const batcommercial = (!isNaN(batcommercialValue) ? batcommercialValue : 0).toLocaleString('fr-FR');\n      \n        const popupContent = `\n        &lt;style&gt;\n          .maplibregl-popup-content {\n            padding: 4px !important;\n            border: 1px solid;\n            border-radius: 8px;\n            width: 270px;\n            box-shadow: rgba(101, 147, 220, 0.2) 0px 4px 8px 0px;\n            border-color: rgba(101, 147, 220, 0.5);\n          }\n        &lt;/style&gt;\n           &lt;div style=\"font-family: sans-serif; font-size: 13px; margin:10px;\"&gt;\n          &lt;div style=\"background-color: #d1ee9c; border: 1px solid; border-radius:8px; margin-bottom:16px; padding:10px;\"&gt;&lt;strong&gt;\n          &lt;center&gt;${nom}&lt;/center&gt;\n          &lt;/strong&gt;&lt;/div&gt;\n          &lt;p style=\"text-align:center !important\"&gt;&lt;strong&gt;- Population :&lt;/strong&gt; ${population}&lt;/p&gt;\n          &lt;p style=\"text-align:center !important\"&gt;&lt;strong&gt;- Nombre de personnes en zone fortement inondable :&lt;/strong&gt; ${dommages}&lt;/p&gt;\n        `;\n      \n        new maplibregl.Popup({closeButton: false})\n          .setLngLat(e.lngLat)\n          .setHTML(popupContent)\n          .addTo(map);\n          \n          // Mettre à jour le conteneur HTML avec les informations spécifiques du marqueur \n         document.getElementById('donnees').innerHTML = `\n          &lt;div style=\"text-align:center; font-family:sans-serif; font-size:16px;\"&gt;\n            &lt;img src=\"${image}\" style=\"width:300px; margin-bottom:10px;\"&gt;&lt;br&gt;\n            \n            &lt;strong style=\"font-size:1.1em;\"&gt;&lt;i class=\"bi bi-geo-alt-fill\"&gt;&lt;/i&gt; Commune :&lt;/strong&gt; ${nom}&lt;br&gt;\n            &lt;strong style=\"font-size:1.1em;\"&gt;&lt;i class=\"bi bi-people-fill\"&gt;&lt;/i&gt; Nombre d'habitants :&lt;/strong&gt; ${population}&lt;br&gt;\n            &lt;strong style=\"font-size:1.1em;\"&gt;&lt;i class=\"bi bi-house-fill\"&gt;&lt;/i&gt; Nombre de bâtiments :&lt;/strong&gt; ${batiments}&lt;br&gt;\n            \n            &lt;div style=\"margin-top:10px;\"&gt;&lt;strong&gt;Dont :&lt;/strong&gt;&lt;/div&gt;\n            &lt;ul style=\"list-style:none; padding:0;\"&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batindif} &lt;strong&gt;bâtiments indifférenciés&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batsportif} &lt;strong&gt;bâtiments sportifs&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batagricole} &lt;strong&gt;bâtiments agricoles&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batresidentiel} &lt;strong&gt;bâtiments résidentiels&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batannexe} &lt;strong&gt;bâtiments annexes&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batreligieux} &lt;strong&gt;bâtiments religieux&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batindustriel} &lt;strong&gt;bâtiments industriels&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n              &lt;li&gt;&lt;h5 style=\"font-size:1em;\"&gt;${batcommercial} &lt;strong&gt;bâtiments commerciaux&lt;/strong&gt;&lt;/h5&gt;&lt;/li&gt;\n            &lt;/ul&gt;\n        \n            &lt;div style=\"margin-top:10px;\"&gt;\n              &lt;strong style=\"font-size:1.1em;\"&gt;&lt;i class=\"bi bi-droplet-half\"&gt;&lt;/i&gt; Nombre de personnes en zone fortement inondable :&lt;/strong&gt; ${dommages}\n            &lt;/div&gt;\n          &lt;/div&gt;\n         `;\n      });\n\n      map.on('mousemove', 'indicateurs12aLayer', (e) =&gt; {\n        if (e.features.length &gt; 0) {\n          const nomCommune = e.features[0].properties.nom;\n      \n          map.setFilter('indicateurs12a-hover', ['==', 'nom', nomCommune]);\n      \n          map.getCanvas().style.cursor = 'pointer';\n        }\n      });\n\n        map.on('mouseleave', 'indicateurs12aLayer', () =&gt; {\n          map.setFilter('indicateurs12a-hover', ['==', 'nom', '']);\n          map.getCanvas().style.cursor = '';\n        });\n      });\n    \n\n    // Interface de contrôle des couches\n    const mapLayersDiv = document.createElement('div');\n    mapLayersDiv.classList.add('mapLayers');\n    mapLayersDiv.style.position = 'absolute';\n    mapLayersDiv.style.zIndex = '1000';\n    mapLayersDiv.innerHTML = `\n      &lt;button id=\"toggleMapMenuButton\" class=\"btn btn-light aria-label=\"Afficher les couches\" title=\"Afficher les couches\"&gt;\n        &lt;img src=\"Images/icons/layers-half.svg\" alt=\"Icône SVG\" width=\"25\" height=\"25\"&gt;\n      &lt;/button&gt;\n      &lt;div id=\"layersList\" style=\"display: none; background: white; padding: 10px; border: 1px solid #ccc;\"&gt;&lt;/div&gt;\n    `;\n    map.getContainer().appendChild(mapLayersDiv);\n\n    const toggleableLayerIds = layersData.map(layer =&gt; layer.id);\n    const aliasLayerIds = {\n      bassinvienneLayer: 'Bassin de la Vienne',\n      regionLayer: 'Région',\n      departementLayer: 'Département',\n      epciLayer: 'EPCI',\n      zoneinondableLayer: 'Zonage Inondable',\n      coursdeauLayer: \"Cours d'eau\",\n      indicateurs12aLayer: 'Bâtiments de plain-pied',\n      batimentsLayer: \"Bâtiments\"\n    };\n\n    function toggleLayerVisibility(id, visible) {\n      const visibility = visible ? 'visible' : 'none';\n      if (map.getLayer(id)) {\n        map.setLayoutProperty(id, 'visibility', visibility);\n      }\n    }\n\n    const layersListDiv = mapLayersDiv.querySelector('#layersList');\n    \n    toggleableLayerIds.forEach(id =&gt; {\n      const name = aliasLayerIds[id] || id;\n\n      const checkbox = document.createElement('input');\n      checkbox.type = 'checkbox';\n      checkbox.id = id;\n      checkbox.className = 'form-check-input';\n      \n      // ✅ Lire la visibilité actuelle directement dans la carte\n      map.once('idle', () =&gt; {\n        const visibility = map.getLayoutProperty(id, 'visibility');\n        checkbox.checked = visibility === 'visible';\n      });\n  \n      checkbox.addEventListener('change', () =&gt; toggleLayerVisibility(id, checkbox.checked));\n\n      const label = document.createElement('label');\n      label.htmlFor = id;\n      label.className = 'form-check-label';\n      label.innerText = name;\n\n      const wrapper = document.createElement('div');\n      wrapper.className = 'form-check';\n      wrapper.appendChild(checkbox);\n      wrapper.appendChild(label);\n\n      layersListDiv.appendChild(wrapper);\n    });\n\n    document.getElementById('toggleMapMenuButton').addEventListener('click', () =&gt; {\n      layersListDiv.style.display = layersListDiv.style.display === 'none' ? 'block' : 'none';\n    });\n     \n\n    // Menu bascule fond de plan\n    const mapMenuDiv = document.createElement('div');\n    mapMenuDiv.classList.add('mapFondDePlan');\n    mapMenuDiv.style.position = 'absolute';\n    mapMenuDiv.style.zIndex = '1000';\n    mapMenuDiv.innerHTML = `\n      &lt;strong&gt;Fond de plan :&lt;/strong&gt;\n      &lt;div class=\"form-check form-switch\"&gt;\n        &lt;input class=\"form-check-input\" type=\"checkbox\" role=\"switch\" id=\"orthoCheckbox\"&gt;\n        &lt;label class=\"form-check-label\" for=\"orthoCheckbox\"&gt;Photos aériennes&lt;/label&gt;\n      &lt;/div&gt;\n    `;\n    map.getContainer().appendChild(mapMenuDiv);\n\n    document.getElementById('orthoCheckbox').addEventListener('change', function (e) {\n      e.preventDefault();\n      e.stopPropagation();\n      toggleStyle(this.checked);\n    });\n  });\n};"
  }
]